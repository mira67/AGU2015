<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Anomaly Detection</title>

	<!-- <script language="javascript" type="text/javascript" src="js/jquery-2.1.4.min.js"></script> -->
	<!--	<script language="javascript" type="text/javascript" src="js/jquery-confirm.min.js"></script> -->
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<link rel="stylesheet" type="text/css" href="css/jquery-confirm.min.css">
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">	
	
	<script src="https://code.jquery.com/jquery-2.1.1.js"></script>
	<script src="https://code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
	<script src="js/jquery-ui-slider-pips.js"></script>
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.10.4/themes/flick/jquery-ui.css">
	<link rel="stylesheet" href="css/jquery-ui-slider-pips.css">
	<link rel="stylesheet" href="css/style.css">
	
	<!-- openlayers needs to compile sooner or error is raised -->
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/proj4js/1.1.0/proj4js-compressed.js"></script>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/openlayers/2.13.1/OpenLayers.js"></script>
	
	<style type="text/css">
		#wrapper {
			height: 97vh;
			width: 97vw;
			margin-left: auto;
			margin-right: auto;
		}
		#content {
			height: 80vh;
		}		
		#sidebar {
			height: 80vh;
		}
		/* start css for maps */
		#map {
			height: 100%;
			width: 100%;
			margin: 0px;
			padding: 0px;
			background: #b4c8c8;
		}
		.olImageLoadError {
			display: none !important;
		}
		#map .olControlAttribution {
			right: 2px;
			bottom: 2px;
			color: #dcddd8;
			font-family: arial;
		}
		#map .olControlAttribution a {
			color: #ffc;
		}
		/* end css for maps */
		
		/* controls box */
		#mapdiv { height:10px; }
		div.olControlAttribution { bottom:3px; }    
		#bbox_drag_instruction { height:1.5em; }
		#bbox_adjust_instruction { height:1.5em; display:none;  }
		/* end controls box */
		#prevNext {
			float: left;
			margin: auto;
		}
	</style>
	
<!-- ///////////////////////////////////////////////////////////////////////////////////////// -->

	<script>
		// function for box
		var vectors;
		var box;
		var transform;
		var maxOpacity = 0.9;
	        var minOpacity = 0.1;

		Proj4js.defs["EPSG:4326"] = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";
		Proj4js.defs["EPSG:3031"] = "+proj=stere +lat_0=-90 +lat_ts=-71 +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
		Proj4js.defs["EPSG:900913"] = "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs";
		// alter the opacity of the climatology image
		function changeOpacity( byOpacity ) {
			var newOpacity = (parseFloat(OpenLayers.Util.getElement('opacity').value) + byOpacity).toFixed(1);
			newOpacity = Math.min(maxOpacity, Math.max(minOpacity, newOpacity));
			OpenLayers.Util.getElement('opacity').value = newOpacity;
			graphic.setOpacity(newOpacity);
        	}
		
		// dynamically add markers to the map using a json object as input
		function addNewMarkers(){	
			var markers2 = new OpenLayers.Layer.Vector("Markers", {
				projection: 'EPSG:4326',
				strategies: [new OpenLayers.Strategy.Fixed()],
					protocol: new OpenLayers.Protocol.HTTP({
					url: "interesting2.json",
					format: new OpenLayers.Format.GeoJSON()
				})
			});
			map.addLayer(markers2);
		}

		function endDrag( bbox ){
			var bounds = bbox.getBounds();
			setBounds(bounds);
			drawBox(bounds);
			box.deactivate();
			document.getElementById("bbox_drag_instruction").style.display = 'none';
			document.getElementById("bbox_adjust_instruction").style.display = 'block';        
		}

		function dragNewBox(){
			box.activate();
			transform.deactivate(); //The remove the box with handles
			vectors.destroyFeatures();
			document.getElementById("bbox_drag_instruction").style.display = 'block';
			document.getElementById("bbox_adjust_instruction").style.display = 'none';
			setBounds(null);
		}

		function boxResize( event ){
			setBounds(event.feature.geometry.bounds);
		}

		function drawBox( bounds ){
			var feature = new OpenLayers.Feature.Vector(bounds.toGeometry());
			vectors.addFeatures(feature);
			transform.setFeature(feature);
		}

		function toPrecision( zoom, value ){
			var decimals = Math.pow(10, Math.floor(zoom/3));
			return Math.round(value * decimals) / decimals;
		}
		
		function setBounds( bounds ){
			if( bounds == null ){
				document.getElementById("bbox_result").innerHTML = "";		  
			} else {

				b = bounds.clone().transform(map.getProjectionObject(), new OpenLayers.Projection("EPSG:4326"))
				minlon = toPrecision(map.getZoom(), b.left);
				minlat = toPrecision(map.getZoom(), b.bottom);
				maxlon = toPrecision(map.getZoom(), b.right);
				maxlat = toPrecision(map.getZoom(), b.top);

				console.log("values: " + minlon + ", " + maxlon + ", " + minlat + ", " + maxlat);
				document.getElementById("bbox_result").innerHTML =
				"<br>minlon: " + minlon + ", " +
				"maxlon: " + maxlon + ",<br>" +
				"minlat: " + minlat + ", " +
				"maxlat: " + maxlat;

				anomalyRequest["minlat"] = minlat;
				anomalyRequest["minlon"] = minlon;
				anomalyRequest["maxlat"] = maxlat;
				anomalyRequest["maxlon"] = maxlon;
				
				loctnArray = [minlat,minlon,maxlat,maxlon]; // update the coordinates
			}
		}
	
		function setupmap() {

			map = new OpenLayers.Map('map', {
				projection: "EPSG:3031",
				displayProjection: "EPSG:4326"
			});

			var lonlat = new OpenLayers.LonLat(-1.788, 53.571).transform(
				new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
				new OpenLayers.Projection("EPSG:900913") // to Spherical Mercator
			);

			vectors = new OpenLayers.Layer.Vector("Vector Layer", {
				displayInLayerSwitcher: false
			});

			var tiles = new OpenLayers.Layer.XYZ(
				'Polar XYZ',
				'http://polar.openstreetmap.de/tiles/${z}/${x}/${y}.png',
				{
					projection: 'EPSG:3031',
					maxExtent: [-3000000,-3000000,3000000,3000000],
					attribution: '© <a href="http://www.openstreetmap.org/">OpenStreetMap</a> contributors',
					numZoomLevels: 20,
					transitionEffect: 'resize'
				}
			)
			map.addLayer(tiles);
		
			// for overlaying the climatology image on top of the map
			graphic = new OpenLayers.Layer.Image(
				'SSMI Image	',
				'images/mar.png',
				new OpenLayers.Bounds(-3929786, -3929786, 3923000, 4323674), // not sure why last number is 43...
				new OpenLayers.Size(1, 1),
				{isBaseLayer: false, opacity: 0.5}
			);
			map.addLayer(graphic);
			
			var markers = new OpenLayers.Layer.Vector("Markers", {
				projection: 'EPSG:4326',
				strategies: [new OpenLayers.Strategy.Fixed()],
					protocol: new OpenLayers.Protocol.HTTP({
					url: "interesting.json",
					format: new OpenLayers.Format.GeoJSON()
				})
			});
			map.addLayer(markers);
				
			var featctl = new OpenLayers.Control.SelectFeature(markers);
			map.addControl(featctl);
			featctl.activate();

			featctl.events.register('featurehighlighted', this, function(e) {
				var pt = e.feature.geometry, ll = new OpenLayers.LonLat(pt.x, pt.y);
				map.setCenter(0, 0);
			});

			map.events.register('zoomend', this, function() {
				markers.setVisibility(map.zoom < 8);
			});

			if( !map.getCenter() ){
				map.setCenter(new OpenLayers.LonLat(0, 0), 1); // despite the class name, these are in EPSG:3031, so 0/0 is actually the pole 
			}

			// begin draw box
			var zoom = 1;
			
			vectors = new OpenLayers.Layer.Vector("Vector Layer", {
				displayInLayerSwitcher: false
			});
			map.addLayer(vectors);

			box = new OpenLayers.Control.DrawFeature(vectors, OpenLayers.Handler.RegularPolygon, {
				handlerOptions: {
					sides: 4,
					snapAngle: 90,
					irregular: true,
					persist: true
				}
			});
			box.handler.callbacks.done = endDrag;
			map.addControl(box);
			
			transform = new OpenLayers.Control.TransformFeature(vectors, {
				rotate: false,
				irregular: true
			});
			
			transform.events.register("transformcomplete", transform, boxResize);
			
			map.addControl(transform);
			map.addControl(box);
			
			box.activate();
			map.setCenter(lonlat, zoom);
			// end draw box
		}
		</script>

<!-- ///////////////////////////////////////////////////////////////////////////////////////// -->
	<script>
		/*User Request Configuration*/
		var sendString = "",
			dataSet = "SSMI",
			frequency = "19",
			polarization = "h",
			startDate = "2010-12-12",
			endDate = "2010-12-20";

		loctnArray = Array();

		/*user request function*/
		var anomalyRequest = {
			"dsName": dataSet,
			"dsFreq": frequency,
			"dsPolar": polarization,
			"sDate": startDate,
			"eDate": endDate,
			"locations": loctnArray,
			"minlat": -71,
			"minlon": -170,
			"maxlat": -76,
			"maxlon": 147
		};

		function updateDate() {
			startDate = "" + document.getElementById('startDate').value;
			endDate = "" + document.getElementById('endDate').value;
			anomalyRequest["sDate"] = startDate;
			anomalyRequest["eDate"] = endDate;
		}

		function changeDataSet(ds) {
			dataSet = ds;
			updateDate();
			anomalyRequest["dsName"] = ds;

/*			if (ds == "AVHRR\\\") {
				document.getElementById("dataset1").style.color = "black";
				document.getElementById("dataset2").style.color = "#B6B6B4";
			} else {
				document.getElementById("dataset2").style.color = "black";
				document.getElementById("dataset1").style.color = "#B6B6B4";
			//}*/
		};

		function changeFrequency(freq) {
			frequency = freq;
			updateDate();
			//update Frequency
			anomalyRequest["dsFreq"] = freq;

			if (freq == '91') {
				document.getElementById("freq91").style.color = "black";
				document.getElementById("freq85").style.color = "#B6B6B4";
				document.getElementById("freq37").style.color = "#B6B6B4";
				document.getElementById("freq22").style.color = "#B6B6B4";
				document.getElementById("freq19").style.color = "#B6B6B4";
			} else if (freq == '85') {

				document.getElementById("freq91").style.color = "#B6B6B4";
				document.getElementById("freq85").style.color = "black";
				document.getElementById("freq37").style.color = "#B6B6B4";
				document.getElementById("freq22").style.color = "#B6B6B4";
				document.getElementById("freq19").style.color = "#B6B6B4";
			} else if (freq == '37') {
				document.getElementById("freq91").style.color = "#B6B6B4";
				document.getElementById("freq85").style.color = "#B6B6B4";
				document.getElementById("freq37").style.color = "black";
				document.getElementById("freq22").style.color = "#B6B6B4";
				document.getElementById("freq19").style.color = "#B6B6B4";
			} else if (freq == '22') {
				document.getElementById("freq91").style.color = "#B6B6B4";
				document.getElementById("freq85").style.color = "#B6B6B4";
				document.getElementById("freq37").style.color = "#B6B6B4";
				document.getElementById("freq22").style.color = "black";
				document.getElementById("freq19").style.color = "#B6B6B4";
			} else {
				document.getElementById("freq91").style.color = "#B6B6B4";
				document.getElementById("freq85").style.color = "#B6B6B4";
				document.getElementById("freq37").style.color = "#B6B6B4";
				document.getElementById("freq22").style.color = "#B6B6B4";
				document.getElementById("freq19").style.color = "black";
			}
		};

		function changePolarization(pol) {
			polarization = pol;
			updateDate();
			anomalyRequest["dsPolar"] = pol;

			if (pol == 'v') {
				document.getElementById("vertical").style.color = "black";
				document.getElementById("horizontal").style.color = "#B6B6B4";
			} else {
				document.getElementById("horizontal").style.color = "black";
				document.getElementById("vertical").style.color = "#B6B6B4";
			}
		}

		//function updatePolyArea(pa) { polyArea = pa; }
		function enablePolygonSearch() {};

		//pass full request to a new page, in localStorage
		function sendRequest(anomalyRequest) {
			updateDate();

			anomalyRequest["dsFreq"] = 's' + frequency + polarization;
			localStorage['userQuery'] = JSON.stringify(anomalyRequest);
			//var win = window.open("anomaly.html",'_blank');
			//win.focus();
			parseRequest();
		};
	</script>
</head>

<!-- ///////////////////////////////////////////////////////////////////////////////////////// -->
<body onload="setupmap()">
<div id="wrapper">
    <header class='container' id='header'></header>

	<nav class='container roundEdge' id='nav'>
		<center><h1 id='project'>Condensing Massive Satellite Data For Rapid Interactive Analysis</h1></center>
	</nav>
	
	<section class='container' id='main'>
		<div id='content'>
			<div id='map'>
				<div class="time"></div>
			</div>
		</div>
			
		<aside id='sidebar' class='roundEdge'>
			<br>
			<img src="images/logoNSIDC.png" alt="logo" style="width:100px;height:100px;">
			<img src="images/logoCU.jpg" alt="logo" style="width:100px;height:100px;"><br><br>
			<span id="updateMarkers"><font color="Black">Update Markers</font></span><br>
			<button id="updateMarkers" class="myButton" onclick="addNewMarkers()">update</button><br><br>
			
			<span id="datasetName"><font color="Black">Data Set</font></span><br>
			<button id="dataset2" class="myButton" onclick="changeDataSet('SSMI')">SSMI</button><br><br>
		
			<span id="datasetFrequency"><font color="Black">Frequency [ SSMI ]</font></span><br>
			<button id="freq19" class="myButton" onclick="changeFrequency('19')">19.3</button>
			<button id="freq22" class="myButton" onclick="changeFrequency('22')">22.2</button>
			<button id="freq37" class="myButton" onclick="changeFrequency('37')">37.0</button><br>
			<button id="freq85" class="myButton" onclick="changeFrequency('85')">85.5</button>
			<button id="freq91" class="myButton" onclick="changeFrequency('91')">91.7</button><br><br>
			
			<span id="datasetPolarization"><font color="Black">Polarization [ SSMI ]</font></span><br>
			<button id="vertical" class="myButton" onclick="changePolarization('v')">vertical</button>
			<button id="horizontal" class="myButton" onclick="changePolarization('h')">horizontal</button><br><br>
		
			<span id="datasetField"><font color="Black">Start Date</font></span><br>
			<input id="startDate" name="startDate" value="2010-12-12" type="date" min="1987-01-01" max="2014-12-31" onclick="updateDate()" /><br><br>
			<span id="datasetField"><font color="Black">End Date</font></span><br>
			<input id="endDate" name="endDate" value="2010-12-20" type="date" min="1987-01-01" max="2014-12-31" onclick="updateDate()" /><br>

			<input class="myButton" value="Submit Query" onclick="sendRequest(anomalyRequest);" type="button">			

			<hr />
			<div id="bbox_drag_instruction">Click to drag a box:</div>
			<div id="bbox_adjust_instruction">Adjust the box<br> <input type="button" value="drag new box" onclick="dragNewBox();"></div>
			<div id="mapdiv"></div>
			<p id="bbox_result"> </p>

			<p>Opacity:
			<a title="decrease opacity" href="javascript: changeOpacity(-0.1);">&lt;&lt;</a>
			<input id="opacity" type="text" value="0.3" size="3" disabled="true" />
			<a title="increase opacity" href="javascript: changeOpacity(0.1);">&gt;&gt;</a>
			</p>


		</aside>
	</section>

	<div id="slider" class="slider"></div>

	<div id="changeDateButtons">
		<center><br><br><br>
		<input class="myButton" value="Query Previous 10 Days" onclick="changeDateRange(-10);" type="button">
		<input class="myButton" value="Query Next 10 Days" onclick="changeDateRange(10);" type="button"><br>
		</center>
	</div>

	<footer class='container' id='footer'>
		<center><p>© 2015 NSIDC & University of Colorado at Boulder</p></center>
	</footer>
	
<!-- ///////////////////////////////////////////////////////////////////////////////////////// -->
	<script>

		requestReturned = 0;
		function parseRequest(e) {
			console.log("making request....");

			ajaxHandle = $.ajax({
				type : "POST",
				contentType : "application/json; charset=utf-8",
				url : "./anomaly/ajaxImutation.do",
				data : localStorage["userQuery"],
				dataType : 'json',
				async : true,
				success : function(response) {
					console.log("ajax success!");
					anomalyRequest = response;
					requestReturned = 1;
					//updatePixels();
				}
			});
		}
	</script>

	<script>
		var months = [ "jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec" ];
		var activeMonth = new Date().getMonth();
		var save = 0;
		sDate = JSON.parse(localStorage.userQuery)["sDate"];
		eDate = JSON.parse(localStorage.userQuery)["eDate"];

		console.log("sDate: " + sDate + ", " + "eDate: " + eDate);
		startDate = new Date(sDate);
		slideDate = startDate;
		cDateNum = startDate;
		arrDates = GetDates(startDate, 10);

		function changeDateRange(num) {
			var currentDate = new Date(slideDate.getDate());
			currentDate.setDate;
			slideDate.setDate(currentDate.getTime() + num);
			arrDates = GetDates(slideDate, 10); // next 10 days

			$(".slider").slider({
				min : 0,
				max : 9,
				value : 0
			}).slider("pips", {
				rest : "label",
				labels : arrDates
			})
		}

		// find the next set of days
		function GetDates(startDate, daysToAdd) {
			var arrDates = [];
			for (var i = 1; i <= daysToAdd; i++) {
				var currentDate = new Date(startDate);
				currentDate.setDate(startDate.getDate() + i);
				arrDates.push(currentDate.getDate() + " "
						+ months[currentDate.getMonth()] + " "
						+ currentDate.getFullYear());
			}
			return arrDates;
		}

		$(".slider").slider({
			min : 0,
			max : 9,
			value : 0
		}).slider("pips", {
			rest : "label",
			labels : arrDates
		})
		.on(
			"slidechange",
			function(e, ui) {
				//$("#labels-months-output").text("You selected " + months[ui.value] + " (" + ui.value + ")");
				$("#image").attr("src", "images/" + months[ui.value] + ".png");
				$( console.log("currentDay: " + arrDates[ui.value]) );
			}
		);
	</script>

</div><!-- end wrapper -->
</body>
</html>

<!-- ///////////////////////////////////////////////////////////////////////////////////////// -->
<!--
Resources:

	SSMI Page:
	<http://nsidc.org/data/docs/daac/nsidc0001_ssmi_tbs.gd.html>

	<http://dev.openlayers.org/examples/draw-feature.html>
	<http://harrywood.co.uk/maps/examples/openlayers/bbox-selector.view.html>

-->

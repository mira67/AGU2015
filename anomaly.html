<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>AGU [results]</title>

<meta name="description" content="">
<meta name="viewport" content="width=device-width">
<script src="js/jquery-2.1.4.min.js"></script>
<script src="https://code.jquery.com/jquery-2.1.1.js"></script>
<script src="https://code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
<script src="js/jquery-ui-slider-pips.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.10.4/themes/flick/jquery-ui.css">
<link rel="stylesheet" href="css/jquery-ui-slider-pips.css">
<link rel="stylesheet" href="css/style.css">

<style type="text/css">
	#wrapper {
		height: 95vh;
		width: 95vw;
		margin-left: auto;
		margin-right: auto;
	}
	#prevNext {
		float: left;
		margin: auto;
	}
	#pics, #image {
		margin: 0px;
		padding: 0px;
	}
</style>

</head>
<body>
<div id="wrapper">

	<center>
	<div id="pics">
		<img id="image" src="images/jan.png" width="664" height="632">
		<canvas id="myCanvas" width="664" height="632">
	</div>
	<!-- pics -->

	<div id="slider" class="slider"></div>

	<div id="changeDateButtons">
		<br> <br> <br> <input class="myButton"
			value="Query Previous 10 Days" onclick="changeDateRange(-10);"
			type="button"> <input class="myButton"
			value="Query Next 10 Days" onclick="changeDateRange(10);"
			type="button"><br>
	</div>

	<script>
		requestReturned = 0;
		window.onload = function(e) {
			console.log("making request....");

			ajaxHandle = $.ajax({
				type : "POST",
				contentType : "application/json; charset=utf-8",
				url : "./anomaly/ajaxImutation.do",
				data : localStorage["userQuery"],
				dataType : 'json',
				async : true,
				success : function(response) {
					console.log("ajax success!");
					//console.log("response: " + response);
					anomalyRequest = response;
					requestReturned = 1;
					updatePixels();

					//hh = new Date(0); hh.setUTCSeconds(anomalyRequest[1]["date"]/1000);
					/*hh = new Date(anomalyRequest[1]["date"]);
					ii = new Date(0); ii.setUTCSeconds(anomalyRequest[anomalyRequest.length-1]["date"]/1000);
					console.log("dates span: " + hh.toDate() + " "+ (hh.getMonth()+1) + " " + hh.getFullYear() + " to " + ii);
					console.log("  where the request asked for: " + JSON.parse(localStorage["userQuery"])["sDate"] + " to " + JSON.parse(localStorage["userQuery"])["eDate"]);
					*/
				}
			});
		}
	</script>

	<script>
		var months = [ "jan", "feb", "mar", "apr", "may", "jun", "jul",
				"aug", "sep", "oct", "nov", "dec" ];
		var activeMonth = new Date().getMonth();
		var save = 0;
		sDate = JSON.parse(localStorage.userQuery)["sDate"];
		eDate = JSON.parse(localStorage.userQuery)["eDate"];

		console.log("sDate: " + sDate + ", " + "eDate: " + eDate);
		startDate = new Date(sDate);
		slideDate = startDate;
		cDateNum = startDate;
		arrDates = GetDates(startDate, 10);

		function changeDateRange(num) {
			var currentDate = new Date(slideDate.getDate());
			currentDate.setDate;
			slideDate.setDate(currentDate.getTime() + num);
			arrDates = GetDates(slideDate, 10); // next 10 days

			$(".slider").slider({
				min : 0,
				max : 9,
				value : 0
			}).slider("pips", {
				rest : "label",
				labels : arrDates
			})
		}

		// find the next set of days
		function GetDates(startDate, daysToAdd) {
			var arrDates = [];
			for (var i = 1; i <= daysToAdd; i++) {
				var currentDate = new Date(startDate);
				currentDate.setDate(startDate.getDate() + i);
				arrDates.push(currentDate.getDate() + " "
						+ months[currentDate.getMonth()] + " "
						+ currentDate.getFullYear());
			}
			return arrDates;
		}

		$(".slider").slider({
			min : 0,
			max : 9,
			value : 0
		}).slider("pips", {
			rest : "label",
			labels : arrDates
		})
		.on(
			"slidechange",
			function(e, ui) {
				//$("#labels-months-output").text("You selected " + months[ui.value] + " (" + ui.value + ")");
				$("#image").attr("src", "images/" + months[ui.value] + ".png");
				$( console.log("currentDay: " + arrDates[ui.value]) );
			}
		);

		// bind the key to the slider
		$(document).keypress(function(e){
			// if left or right key pressed
			if( e.which == 39){
				//$(".slider").click();
				$( console.log("click"));
			}
		});
	</script>


	<script>
		updatePixels = function() {
			var k, j = 0;
			var foo = [];
			
			var c = document.getElementById("myCanvas");
			var ctx = c.getContext("2d");
			var img = document.getElementById("image");
			ctx.clearRect(0, 0, c.width, c.height); // clear before redraw
			ctx.drawImage(img, 0, 0);
			var imgData = ctx.getImageData(0, 0, c.width, c.height);
			var sliderValue = 0;

			// wait for ajax response
			if( requestReturned == 1 ){
				sliderValue = $(".slider").slider("value"); // which selection is highlighted
				//console.log("date of slider: " + '\n' + (slideDate.getTime()+sliderValue*24*60*60*1000) / 1000);
				//console.log("date of anomaly [1]" + '\n' + (anomalyRequest[1]["date"]/1000+(60*60*7)) );
				timeSeconds = (slideDate.getTime()+sliderValue*24*60*60*1000);
				
				slDate = new Date(0);
				slDate.setUTCSeconds( (slideDate.getTime()+(sliderValue+1)*24*60*60*1000) / 1000 );
				aReq = new Date(0);
				aReq.setUTCSeconds(anomalyRequest[1]["date"]/1000);
				
				console.log("slideDate: " + slDate.getDate() + " "+ (slDate.getMonth()+1) + " " + slDate.getFullYear());
				console.log("requestDate: " + aReq.getDate() + " "+ (aReq.getMonth()+1) + " " + aReq.getFullYear());
				
				for (k = 0; k < anomalyRequest.length; k++) {
					foo = anomalyRequest[k];
					num = foo["date"] / 1000;
					d = new Date(0); // set date to epoch
					d.setUTCSeconds(num);

					// if the slider day matches any of the json anomalies
					if( d.getDate() == slDate.getDate() 
						&& d.getMonth() == slDate.getMonth()
						&& d.getFullYear() == slDate.getFullYear() ){
			
						longi = foo["longi"];
						lati = foo["lati"];
						//console.log("x: " + lati + ", y:" + longi + "k: " + k);

						indice = longi * 4 * c.width + lati * 4; // cartesian to vector transform
						//for(j = 0; j < imgData.data.length; j++){

/*						imgData.data[indice] = 255;
						imgData.data[indice + 1] = 0;
						imgData.data[indice + 2] = 0;
						imgData.data[indice + 3] = 255;
	*/					
						// draw rectangle
						ctx.fillStyle="#FF0000";
						ctx.globalAlpha = 0.3;
						ctx.fillRect(lati, longi, 20, 20); 
						
						ctx.globalAlpha = 1;

					}
					ctx.stroke();
				}
				//ctx.putImageData(imgData, 0, 0);
								
				/*
				// draw a red circle
				ctx.beginPath();
				ctx.lineWidth = 5;
				ctx.strokeStyle = '#ff0000';
				ctx.arc(100, 150, 50, 0, 2 * Math.PI);
				ctx.stroke();
				
				// draw rectangle
				ctx.fillStyle="#FF0000";
				ctx.globalAlpha = 0.03
				ctx.fillRect(90, 90, 190, 190); 
				ctx.stroke();
				*/

			}
		}
	</script>

	<script>
		document.getElementById("image").onload = function() {
			updatePixels();
		}
		updatePixels();
	</script>
	</center>
</div><!-- end wrapper -->
</body>
</html>

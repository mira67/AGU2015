<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<title>AGU [results]</title>

<meta name="description" content="">
<meta name="viewport" content="width=device-width">
<script src="js/jquery-2.1.4.min.js"></script>
<script src="https://code.jquery.com/jquery-2.1.1.js"></script>
<script src="https://code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
<script src="js/jquery-ui-slider-pips.js"></script>
<link rel="stylesheet" href="https://code.jquery.com/ui/1.10.4/themes/flick/jquery-ui.css">
<link rel="stylesheet" href="css/jquery-ui-slider-pips.css">
<link rel="stylesheet" href="css/style.css">

<style type="text/css">
#content {
	height: 90vh;
}

#sidebar {
	height: 90vh;
}

#prevNext {
	float: left;
	margin: auto;
}

#pics, #image {
	margin: 0;
	padding: 0;
}
</style>

</head>
<body id="index" class="home">

	<header class='container' id='header'>
		<nav class='container roundEdge' id='nav'>
			<center>
				<h1 id='project'>Anomaly Analysis Results</h1>
			</center>
		</nav>
	</header>

	<section class='container' id='main'>
		<section id='content'>

			<div id="pics">
				<img id="image" src="images/jan.png" width="664" height="632"
					style="border: 1px solid black;">
				<canvas id="myCanvas" width="664" height="632"
					style="border: 1px solid black;">
			</div>
			<!-- pics -->

			<div class="slider"></div>

			<div id="changeDateButtons">
				<br> <br> <br> <input class="myButton"
					value="Query Previous 10 Days" onclick="changeDateRange(-10);"
					type="button"> <input class="myButton"
					value="Query Next 10 Days" onclick="changeDateRange(10);"
					type="button"><br>
				<!--
			<input class="myButton" value="toggle red channel" onclick="red = invertColor(red);" type="button">
			<input class="myButton" value="toggle blue channel" onclick="green = invertColor(green);" type="button">
			<input class="myButton" value="toggle green channel" onclick="blue = invertColor(blue);" type="button">
			-->
			</div>

			<script>
				requestReturned = 0;
				window.onload = function(e) {
					console.log("making request....");

					ajaxHandle = $.ajax({
						type : "POST",
						contentType : "application/json; charset=utf-8",
						url : "./anomaly/ajaxImutation.do",
						data : localStorage["userQuery"],
						dataType : 'json',
						async : true,
						success : function(response) {
							console.log("ajax success");
							console.log("response: " + response);
							anomalyRequest = response;
							requestReturned = 1;
							updatePixels();
						}
					});
				}
			</script>

			<script>
				var months = [ "jan", "feb", "mar", "apr", "may", "jun", "jul",
						"aug", "sep", "oct", "nov", "dec" ];
				var activeMonth = new Date().getMonth();
				var save = 0;
				sDate = JSON.parse(localStorage.userQuery)["sDate"];
				eDate = JSON.parse(localStorage.userQuery)["eDate"];

				console.log("sDate: " + sDate + ", " + "eDate: " + eDate);
				startDate = new Date(sDate);
				slideDate = startDate;
				cDateNum = startDate;
				arrDates = GetDates(startDate, 10);

				function changeDateRange(num) {
					var currentDate = new Date(slideDate.getDate());
					currentDate.setDate;
					slideDate.setDate(currentDate.getTime() + num);
					arrDates = GetDates(slideDate, 10); // next 10 days

					$(".slider").slider({
						min : 0,
						max : 9,
						value : 0
					}).slider("pips", {
						rest : "label",
						labels : arrDates
					})
				}

				// find the next set of days
				function GetDates(startDate, daysToAdd) {
					var arrDates = [];
					for (var i = 1; i <= daysToAdd; i++) {
						var currentDate = new Date(startDate);
						currentDate.setDate(startDate.getDate() + i);
						arrDates.push(currentDate.getDate() + " "
								+ months[currentDate.getMonth()] + " "
								+ currentDate.getFullYear());
					}
					return arrDates;
				}

				$(".slider").slider({
					min : 0,
					max : 9,
					value : 0
				}).slider("pips", {
					rest : "label",
					labels : arrDates
				})
				// and whenever the slider changes, lets echo out the month
				.on(
					"slidechange",
					function(e, ui) {
						$("#labels-months-output").text("You selected " + months[ui.value] + " (" + ui.value + ")");
						$("#image").attr("src", "images/" + months[ui.value] + ".png");
						$( console.log("currentDay: " + arrDates[ui.value]) );
						//$( save = ui.value] );
					}
				);
			</script>


			<script>
				updatePixels = function() {
					var k, j = 0;
					var foo = [];
					var d = new Date(0); // set date to epoch
					
					var c = document.getElementById("myCanvas");
					var ctx = c.getContext("2d");
					var img = document.getElementById("image");
					ctx.drawImage(img, 0, 0);
					var imgData = ctx.getImageData(0, 0, c.width, c.height);
					var sliderValue = 0;
					// wait for ajax response
					if( requestReturned == 1 ){
						sliderValue = $(".slider").slider("value");
						console.log("dateadsf: " + (slideDate.getTime()+sliderValue*24*60*60*1000) / 1000);
						timeSeconds = (slideDate.getTime()+sliderValue*24*60*60*1000);
						
						for (k = 0; k < anomalyRequest.length; k++) {
							foo = anomalyRequest[k];
							num = foo["date"] / 1000;
							d.setUTCSeconds(num);

							if( d.getTime() == timeSeconds ){
					
								//if( d == sDate ){

								//console.log("date: " + d + " " + k);
								longi = foo["longi"];
								lati = foo["lati"];
								//console.log("x: " + lati + ", y:" + longi + "k: " + k);

								indice = longi * 4 * c.width + lati * 4; // cartesian to vector transform

								//for(j = 0; j < imgData.data.length; j++){
								imgData.data[indice] = 255;
								imgData.data[indice + 1] = 0;
								imgData.data[indice + 2] = 0;
								imgData.data[indice + 3] = 255;
								//}					
								//console.log("image size: " + imgData.data.length);	 
								//console.log(indice);
								//}
							}
						}
					}
					ctx.putImageData(imgData, 0, 0);

					// draw a red circle
					ctx.beginPath();
					ctx.lineWidth = 5;
					ctx.strokeStyle = '#ff0000';
					ctx.arc(100, 150, 50, 0, 2 * Math.PI);
					ctx.stroke();
				}
			</script>

			<!--
	</section>
        <aside id="sidebar" class="roundEdge"><br>
			<img src="images/jan.png" alt="logo" style="width:200px;height:200px;">
			<p>January</p>
			<img src="images/feb.png" alt="logo" style="width:200px;height:200px;">
			<p>February</p>
			<img src="images/mar.png" alt="logo" style="width:200px;height:200px;">
			<p>March</p>
		</aside>
    </section>
	-->

			<footer class='container' id='footer'>
				<center>
					<p>Â© 2015 NSIDC & University of Colorado at Boulder</p>
				</center>
			</footer>

			<script>
				document.getElementById("image").onload = function() {
					updatePixels();
				}
				updatePixels();
			</script>
</body>
</html>

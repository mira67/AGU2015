<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<title>‚ùÑ Antarctica</title>

	<script src="proj4js-2.3.3/proj4.js"></script>
	<link rel="stylesheet" href="openlayers-3.4.0/ol.css"/>
	<link rel="stylesheet" href="css/example.css"/>
	<script src="openlayers-3.4.0/ol.js"></script>
	<script src="antarctic-epsg3031.js"></script>
	
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.1.4.js"></script>
    <script src="https://code.jquery.com/ui/1.11.1/jquery-ui.js"></script>
    <script src="js/jquery-ui-slider-pips.js"></script>
	<link rel="stylesheet" href="css/jquery-ui-slider-pips.css">
	<link rel="stylesheet" href="https://code.jquery.com/ui/1.10.4/themes/flick/jquery-ui.css">	

	<style>
		html {
			overflow: hidden;
		}
		body {
			font-family: 'Roboto', 'Helvetica', 'Arial', 'Sans Serif';
			max-width: 100%;
			overflow-x: hidden;
			background: url('images/snow2.jpg') no-repeat center center fixed;
			-webkit-background-size: cover;
			-moz-background-size: cover;
			-o-background-size: cover;
			background-size: cover;
			margin: 0; padding: 0;
			height:100%;
		}
		.background {
			position: fixed;
			top: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
		}
		#top {
			clear: left;
			width: 100vw;
			height: 90vh;
		}
		#bottom {
			clear: left;
			width: 90vw;
			height: 18vh;
		}
		#mapContainer {
			float: left;
			width: 75vw;
			height: 100%;
			background-color: #aaa;
		}
		#map { height: 100%; }
		#sidebar {
			float: left;
			width: 24vw;
			height: 100%;
			background-color: #999;
		}
		#timelineBox{
			width: 99vw;
			height: 10vh;
			background-color: rgba(255,255,255,0.4);
			text-align: center;
			background-color: #bbb;
		}
		p {
			color: #fff;
			font-size: 1em;
			text-align: left;
		}
		#darkText {
			color: #999;
		}
		.outputResultsBack {
			background-color: "#00FF00";
			float: right;
			width: 100px;
			height: 100px;
			overflow: scroll;
			font-size: 0.7em;
		}
		.row {
			width: 92%;
			margin-left: 3%;
			position: relative;
			float: left;
			display: inline-block;
			text-align: center;
		}
		.slide {
			margin: 0 2% 0 2%;
		}
		.btn {
			display: inline-block;
			border-radius: 5px;
			border: none;
			height: 30px;
			padding: 0;
			margin: 10px;
			font-size: 1em;
			letter-spacing: 3px;
		}
		.btn:active {
			font-size: 1.1em;
			letter-spacing: 4px;
		}
		.sm { width: 19%; }
		.thr { width: 32%; }
		.md { width: 48%; }
		.lg { width: 98%; }
	</style>
	
</head>
<body>
<div class="background"></div>
<div id="wrapper">

	<div id="top">
		
		<div id="mapContainer">
			<div id="map"></div>
		</div>
		
		<div id="sidebar">
		
			<div class="row">
				<div class="mutual">
					<p>Frequency: 
					<span id="darkText">
					19<input id="chk19" name="chk19" type="checkbox" value="19" class="checkbox">
					22<input id="chk22" name="chk22" type="checkbox" value="22" class="checkbox">
					37<input id="chk37" name="chk37" type="checkbox" value="37" class="checkbox" checked>
					85<input id="chk85" name="chk85" type="checkbox" value="85" class="checkbox">
					91<input id="chk91" name="chk91" type="checkbox" value="91" class="checkbox">
					</span>
					</p>
				</div>
			</div>
			
			<div class="row">
				<div class="mutual">
					<p>Polarization: 
					<span id="darkText">
					vertical<input id="chkVertical" name="chkVertical" type="checkbox" value="vertical" class="checkbox" checked>
					horizontal<input id="chkHorizontal" name="chkHorizontal" type="checkbox" value="horizontal" class="checkbox">
					</span>
					</p>
				</div>
			</div>

			<div class="row">
				<div class="mutual">
					<p>Timeline Zoom: 
					<span id="darkText">
					days<input id="chkDay" name="chkDay" type="checkbox" value="day" class="checkbox" checked>
					months<input id="chkMonth" name="chkMonth" type="checkbox" value="month" class="checkbox">
					years<input id="chkYear" name="chkYear" type="checkbox" value="year" class="checkbox">
					</span>
					</p>
				</div>
			</div>
			
			<div class="row"><p>Baseline Image Opacity</p><p id="layerOpacityText"></p></div>
			<div class="row">
				<div class="slide sliderLayerOpacity"></div>
			</div>
			
			<div class="row"><p>Climatology Opacity</p><p id="markerOpacityText"></p></div>
			<div class="row">
				<div class="slide sliderMarkerOpacity"></div>
			</div>
			
			<div class="row"><p>Heatmap Opacity</p><p id="heatmapOpacityText"></p></div>
			<div class="row">
				<div class="slide sliderHeatmapOpacity"></div>
			</div>
			
			<div class="row"><p>Range of Years</p><p id="yearsText"></p></div>
			<div class="row">
				<div class="slide sliderYears"></div>
			</div>

			<div class="row"><p>Pattern</p><p id="patternText"></p></div>
			<div class="row">
				<div class="slide sliderPattern"></div>
			</div>

			<div class="row">
				<form class="form-inline">
					<label>Draw &nbsp;</label>
					<select id="type">
						<option value="None">None</option>
						<option value="Box">Box</option>
					</select>
				</form>
				<p id="extent"></p>
				<!--<button onclick="buttonDrawRectangle();">draw rectangle</button>-->
				<button onclick="buttonClearRectangle();">clear rectangle</button>
			</div>
			
			<div class="row">
				<button class="btn md" onclick="sendRequest(anomalyRequest, 0);">submit query</button>
			</div>

			<div class="row outputResultsBack">
				<div id="outputResults"></div>
			</div>
		
		</div>
	</div><!-- end top -->
	
	<div id="bottom">
		<div id="timelineBox">
			<div>
				<div class="row"><p id="timelineText"></p></div>
				<div class="row">
					<div class="slide sliderTimeline"></div>
				</div>
			</div>
		</div>
	</div><!-- end bottom -->
	
</div><!-- end wrapper -->

<script type="text/javascript">

	//var visiblity = new ol.dom.Input(document.getElementById('visible'));
	//visible.bindTo('checked', imageLayer, 'visible');
	var months = ["jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec"];
	var dataSet = "SSMI";
	var frequency = "19";
	var polarization = "h";
	var startDate = "2010-12-12";
	var endDate = "2010-12-20";

	// bounding box for request
	var loctnArray = Array();
	loctnArray[0] = { "longitude": -39.3, "latitude": -42.5 };
	loctnArray[1] = { "longitude": -41.4, "latitude": 136 };
	
	var startYear = 1987; // set up as the same for the slider
	var endYear = 2014;
	var startMonth = 0;
	var endMonth = 11;

	anomalyRequest = {
		"dsName": dataSet,
		"dsFreq": frequency,
		"dsPolar": polarization,
		"sDate": startDate,
		"eDate": endDate,
		"locations": loctnArray
	};

	// variables that control the timelilne view -- start zoomed to years
	var minYear = 1987;
	var maxYear = 2014;
	var sliderTimelineMin = minYear;
	var sliderTimelineMax = maxYear;
	var sliderTimelineStep = 1;
	var sliderTimelineValue = 1;
	var timelineZoomLevel = "day";
/*
	$('button').click(function () {
		$(this).css('border', '5px solid #444');
		$(this).css('background', '#eee');
	});
*/
	
	// http://jsfiddle.net/3TssG/
	$('.mutual .checkbox').click( function( ){
		var checkedState = $(this).prop("checked")
			$(this)
				.parent('div')
				.children('.checkbox:checked')
				.prop("checked", false);
		$(this).prop("checked", checkedState);
		$( updateResults( anomalyRequest ) );
		$( updateDateValues() );
	});	

	// change opacity of the layer
	$(".sliderLayerOpacity")
    .slider({
		min: 0,
        max: 1,
		step: 0.05,
		value: 1,
		slide: function( event, ui ){
			//$("#layerOpacityText").text( ui.value );
			$( layerBaseMap.setOpacity( ui.value) );
		},
		change: function( event, ui ){
			//$("#layerOpacityText").text( ui.value );
			$( layerBaseMap.setOpacity( ui.value) );
		}
    })
    .slider("pips", {
        rest: "label",
		step: 5
    })
	.on("slidechange", function( event, ui ){
		//$("#layerOpacityText").text( ui.value );
		$( layerBaseMap.setOpacity( ui.value) );
		$( updateResults( anomalyRequest ) );
    });

	// change opacity of the markers
	$(".sliderMarkerOpacity")
    .slider({
		min: 0,
        max: 1,
		step: 0.05,
		value: 0.75,
		slide: function( event, ui ){
			//$("#markerOpacityText").text( ui.value );
			$( imageLayer.setOpacity( ui.value ) );
		},
		change: function( event, ui ){
			//$("#markerOpacityText").text( ui.value );
			$( imageLayer.setOpacity( ui.value ) );
		}
    })
    .slider("pips", {
        rest: "label",
		step: 5
    })
	.on("slidechange", function( event, ui ){
		//$("#markerOpacityText").text( ui.value );
		$( imageLayer.setOpacity( ui.value ) );
		$( updateResults( anomalyRequest ) );
    });
	
	// sliderHeatmapOpacity
	$(".sliderHeatmapOpacity")
    .slider({
		min: 0,
        max: 1,
		step: 0.05,
		value: 1,
		slide: function( event, ui ){
			//$("#markerOpacityText").text( ui.value );
			$( heatmapLayer.setOpacity( ui.value ) );
		},
		change: function( event, ui ){
			//$("#markerOpacityText").text( ui.value );
			$( heatmapLayer.setOpacity( ui.value ) );
		}
    })
    .slider("pips", {
        rest: "label",
		step: 5
    })
	.on("slidechange", function( event, ui ){
		//$("#markerOpacityText").text( ui.value );
		$( heatmapLayer.setOpacity( ui.value ) );
		$( updateResults( anomalyRequest ) );
    });
	
	// user input of the date
	$(".sliderYears")
		.slider({
			min: minYear,
			max: maxYear,
			range: true,
			step: 1,
			values: [2001, 2011],
			//this gets a live reading of the value and prints it on the page
			slide: function( event, ui ){
				//$("#yearsText").text( ui.values[0] + " to " + ui.values[1] );
			},
			change: function( event, ui ){
				//$("#yearsText").text( ui.values[0] + " to " + ui.values[1] );
			}
		})
		.slider("pips", {
			rest: "label",
			step: 3
		})
		.on("slidechange", function( event, ui ){
			//$("#yearsText").text( ui.values[0] + " to " + ui.values[1] );
			$( updateResults( anomalyRequest ) );
    });

	// slider for patterns of date input
	$(".sliderPattern")
		.slider({ 
			min: 0, 
			max: months.length-1,
			range: true,
			values: [0, 11],
			slide: function( event, ui ){
				//$("#patternText").text( months[ui.values[0]] + " to " + months[ui.values[1]] );
			},
			change: function( event, ui ){
				//$("#patternText").text( months[ui.values[0]] + " to " + months[ui.values[1]] );
			}

		})
		.slider("pips", {
			rest: "label",
			labels: months
		})
		.on("slidechange", function( event ,ui ){
			//$("#patternText").text( months[ui.values[0]] + " to " + months[ui.values[1]] );
			$( updateResults( anomalyRequest ) );
    });

	// slider for main timeline at bottom of page
	$(".sliderTimeline")
		.slider({ 
			min: sliderTimelineMin,
			max: sliderTimelineMax,
			step: sliderTimelineStep,
			values: [sliderTimelineMin, sliderTimelineMax],
			slide: function( event, ui ){
				//$("#timelineText").text( ui.value );
			},
			change: function( event, ui ){
				//$("#timelineText").text( ui.value );
			}
		})
		.slider("pips", {
			rest: "label",
			step: 1
		})
		.on("slidechange", function( event ,ui ){
			//$("#timelineText").text( ui.value );
			$( updateResults( anomalyRequest ) );
    });

	// updates the variables that will be input into the query
	function updateResults( anomalyRequest ){	
		// determine frequency
		if( $("#chk19").is(':checked') ){
			frequency = "19";
		} else if( $("#chk22").is(':checked') ){
			frequency = "22";
		} else if( $("#chk37").is(':checked') ){
			frequency = "37";
		} else if( $("#chk85").is(':checked') ){
			frequency = "85";
		} else if( $("#chk91").is(':checked') ){
			frequency = "91";
		} else {
			frequency = "19";
		}
		
		// determine polarization
		if( $("#chkVertical").is(':checked') ){
			polarization = "v";
		} else if( $("#chkHorizontal").is(':checked') ){
			polarization = "h";
		} else {
			polarization = "v";
		}
		
		// determine timeline zoom
		if( $("#chkDay").is(':checked') ){
			timelineZoomLevel = "day";
		} else if( $("#chkMonth").is(':checked') ){
			timelineZoomLevel = "month";
		} else if( $("#chkYear").is(':checked') ){
			timelineZoomLevel = "year";
		} else {
			timelineZoomLevel = "day";
		}
		
		startYear = $(".sliderYears").slider("values")[0];
		endYear = $(".sliderYears").slider("values")[1];
		startMonth = $(".sliderPattern").slider("values")[0] + 1;
		endMonth = $(".sliderPattern").slider("values")[1] + 1;
		
		startDate = startYear + "-" + ("00" + startMonth).slice(-2) + "-01";
		endDate = endYear + "-" + ("00" + startMonth).slice(-2) + "-01";

		document.getElementById("outputResults").innerHTML =
			"<p>" + dataSet + ", " + frequency + ", " + polarization + ", " + startDate + ", " + endDate + "<br>"
			//+ "timeline zoom: " + timelineZoomLevel + "</p>"
			//+ "layer opacity: " + $(".sliderLayerOpacity").slider("value") + "</p>"
			//+ "marker opacity: " + $(".sliderMarkerOpacity").slider("value") + "</p>"
			+ "slider years: " + startYear + ", " + endYear + "<br>"
			+ "slider pattern: " + months[$(".sliderPattern").slider("values")[0]] + " to " + months[$(".sliderPattern").slider("values")[1]] + "<br>"
			+ "dates: " + startDate + ", " + endDate + "</p>"
			//+ "location array: " + loctnArray[0] + ", " + loctnArray[1] + "</p>";
		
		// update anomaly request values
		anomalyRequest["dsName"] = dataSet;
		anomalyRequest["dsFreq"] = "s" + frequency + polarization;
		anomalyRequest["dsPolar"] = polarization;
		anomalyRequest["sDate"] = startDate;
		anomalyRequest["eDate"] = endDate;
		anomalyRequest["locations"] = loctnArray
	}
	
	// http://jsfiddle.net/jfhartsock/cM3ZU/
	Date.prototype.addDays = function ( days ){
		var dat = new Date(this.valueOf())
		dat.setDate(dat.getDate() + days);
		return dat;
	}
	function getDates( startDate, stopDate ){
		var dateArray = new Array();
		var currentDate = startDate;
		while( currentDate <= stopDate ){
			dateArray.push(currentDate)
			currentDate = currentDate.addDays(1);
		}
		return dateArray;
	}

	// update labels of timeline pips
	function updateDateValues() {

		// generate a list of all days between start and end of input
		var beginningDate = new Date(startDate);
		var endingDate = new Date(endDate);

		dateArray = getDates(beginningDate, endingDate);

// print out all the dates to the console		
for( i = 0; i < dateArray.length; i++ ){
	console.log( dateArray[i] );
}
		
		if( $("#chkMonth").is(':checked') ){
			// months
			$(".sliderTimeline")
			.slider({
				min: 0,
				max: 11,
				step: 1,
				value: 5
			}).slider("pips", {
				rest: "label",
				labels: months
			});
		} else if( $("#chkYear").is(':checked') ){
			// years
			$(".sliderTimeline")
			.slider({
				min: minYear,
				max: maxYear,
				step: 1,
				value: 1
			}).slider("pips", {
				rest: "label",
				step: 1
			});
		} else {
			// days
			$(".sliderTimeline")
			.slider({
				min: 0,
				max: 31,
				step: 1,
				value: 0
			}).slider("pips", {
				rest: "label",
				step: 1
			});
		}
	}

	function sendRequest( anomalyRequest, mode ){
	
		anomalyRequest["dsName"] = dataSet;
		anomalyRequest["dsFreq"] = "s" + frequency + polarization;
		anomalyRequest["dsPolar"] = polarization;
		anomalyRequest["sDate"] = "2012-12-01";//startDate;
		anomalyRequest["eDate"] = "2012-12-31";//endDate;
		anomalyRequest["locations"] = loctnArray
		
		console.log("anomalyRequest" + anomalyRequest);
		localStorage['userQuery'] = JSON.stringify(anomalyRequest);
		console.log("localStorage: " + localStorage['userQuery']);
		
		updateDateValues();
		
		parseRequest();
		//parseRequest(); //send and parse results
		//updateDateValues(); //first 10 days from user query
	};

	
	requestReturned = 0;	
	function parseRequest( e ){
		console.log("making request....");

		ajaxHandle = $.ajax({
			type : "POST",
			contentType : "application/json; charset=utf-8",
			url : "http://localhost:8080/condensate-web/anomaly/ajaxRetrvAnomaly.do",
			data : localStorage["userQuery"],
			dataType : 'json',
			async : true,
			success : function(response) {
				console.log("ajax success!________________ajax success!");
				console.log("respones: " + response);
				//anomalyRequest = response;
				//requestReturned = 1;
				//updatePixels();
			}
		});
	}

	updateResults(anomalyRequest);

/////////////////////////////////////////////////////
	var draw;
	var typeSelect = document.getElementById('type');	
	
	function addInteraction( ){
		value = typeSelect.value;
console.log("value: " + value);
		if( value !== 'None' ){
console.log("2");
			var geometryFunction, maxPoints;
			if( value === 'Box' ){
console.log("3");
				value = 'LineString';
				maxPoints = 2;
				geometryFunction = function( coordinates, geometry ){
					if( !geometry ){
						geometry = new ol.geom.Polygon(null);
					}
					var start = coordinates[0];
					var end = coordinates[1];
					geometry.setCoordinates([[start, [start[0], end[1]], end, [end[0], start[1]], start]]);
console.log("coordinates" + coordinates);					
					return geometry;
				};
			}
			draw = new ol.interaction.Draw({
				source: source,
				type: /** @type {ol.geom.GeometryType} */ (value),
				geometryFunction: geometryFunction,
				maxPoints: maxPoints
			});
			map.addInteraction(draw);
		}
console.log("4");
	}

	typeSelect.onchange = function(e) {
		map.removeInteraction(draw);
		addInteraction();
	};

	buttonClearRectangle = function(){
		source.clear();
	};	
	
	addInteraction();
</script>

</body>
</html>

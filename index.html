<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
	<title>AGU [query]</title>

	<!--<meta name="viewport" content="width=device-width, initial-scale=1.0">-->
	<!-- openlayers needs to compile sooner or error is raised -->
	<script src="http://cdnjs.cloudflare.com/ajax/libs/proj4js/1.1.0/proj4js-compressed.js"></script>
	<script language="javascript" type="text/javascript" src="js/jquery-2.1.4.min.js"></script>
	<script language="javascript" type="text/javascript" src="js/jquery-confirm.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<link rel="stylesheet" type="text/css" href="css/style.css">
	<link rel="stylesheet" type="text/css" href="css/jquery-confirm.min.css">
	<link rel="stylesheet" type="text/css" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">	

	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/proj4js/1.1.0/proj4js-compressed.js"></script>
	<script type="text/javascript" src="http://cdnjs.cloudflare.com/ajax/libs/openlayers/2.13.1/OpenLayers.js"></script>
	
	<style type="text/css">
		#content {
			height: 90vh;
		}		
		#sidebar {
			height: 90vh;
		}
		/* start css for maps */
		#map {
			height: 100%;
			width: 100%;
			margin: 0px;
			padding: 0px;
			background: #b4c8c8;
		}
		.olImageLoadError {
			display: none !important;
		}
		#map .olControlAttribution {
			right: 2px;
			bottom: 2px;
			color: #dcddd8;
			font-family: arial;
		}
		#map .olControlAttribution a {
			color: #ffc;
		}
		/* end css for maps */
		
		/* controls box */
		#mapdiv { height:10px; }
		div.olControlAttribution { bottom:3px; }    
		#bbox_drag_instruction { height:1.5em; }
		#bbox_adjust_instruction { height:1.5em; display:none;  }
		/* end controls box */
	</style>
	
	<script>
		// function for box
		var vectors;
		var box;
		var transform;

		Proj4js.defs["EPSG:4326"] = "+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs";
		Proj4js.defs["EPSG:3031"] = "+proj=stere +lat_0=-90 +lat_ts=-71 +lon_0=0 +k=1 +x_0=0 +y_0=0 +ellps=WGS84 +datum=WGS84 +units=m +no_defs";
		Proj4js.defs["EPSG:900913"] = "+proj=merc +a=6378137 +b=6378137 +lat_ts=0.0 +lon_0=0.0 +x_0=0.0 +y_0=0 +k=1.0 +units=m +nadgrids=@null +no_defs";

		
		function endDrag( bbox ){
			var bounds = bbox.getBounds();
			setBounds(bounds);
			drawBox(bounds);
			box.deactivate();
			document.getElementById("bbox_drag_instruction").style.display = 'none';
			document.getElementById("bbox_adjust_instruction").style.display = 'block';        
		}

		function dragNewBox(){
			box.activate();
			transform.deactivate(); //The remove the box with handles
			vectors.destroyFeatures();
			document.getElementById("bbox_drag_instruction").style.display = 'block';
			document.getElementById("bbox_adjust_instruction").style.display = 'none';
			setBounds(null);
		}

		function boxResize( event ){
			setBounds(event.feature.geometry.bounds);
		}

		function drawBox( bounds ){
			var feature = new OpenLayers.Feature.Vector(bounds.toGeometry());
			vectors.addFeatures(feature);
			transform.setFeature(feature);
		}

		function toPrecision( zoom, value ){
			var decimals = Math.pow(10, Math.floor(zoom/3));
			return Math.round(value * decimals) / decimals;
		}
		
		function setBounds( bounds ){
			if( bounds == null ){
				document.getElementById("bbox_result").innerHTML = "";		  
			} else {

				b = bounds.clone().transform(map.getProjectionObject(), new OpenLayers.Projection("EPSG:4326"))
				minlon = toPrecision(map.getZoom(), b.left);
				minlat = toPrecision(map.getZoom(), b.bottom);
				maxlon = toPrecision(map.getZoom(), b.right);
				maxlat = toPrecision(map.getZoom(), b.top);

				console.log("values: " + minlon + maxlon + minlat + maxlat);
				document.getElementById("bbox_result").innerHTML =
				"<br>minlon: " + minlon + ", " +
				"maxlon: " + maxlon + ",<br>" +
				"minlat: " + minlat + ", " +
				"maxlat: " + maxlat;

				anomalyRequest["minlat"] = minlat;
				anomalyRequest["minlon"] = minlon;
				anomalyRequest["maxlat"] = maxlat;
				anomalyRequest["maxlon"] = maxlon;
				
				loctnArray = [minlat,minlon,maxlat,maxlon]; // update the coordinates
			}
		}
	
		function setupmap() {

			map = new OpenLayers.Map('map', {
				projection: "EPSG:3031",
				displayProjection: "EPSG:4326"
			});

			var lonlat = new OpenLayers.LonLat(-1.788, 53.571).transform(
				new OpenLayers.Projection("EPSG:4326"), // transform from WGS 1984
				new OpenLayers.Projection("EPSG:900913") // to Spherical Mercator
			);

			vectors = new OpenLayers.Layer.Vector("Vector Layer", {
				displayInLayerSwitcher: false
			});

			var tiles = new OpenLayers.Layer.XYZ(
				'Polar XYZ',
				'http://polar.openstreetmap.de/tiles/${z}/${x}/${y}.png',
				{
					projection: 'EPSG:3031',
					maxExtent: [-3000000,-3000000,3000000,3000000],
					attribution: '© <a href="http://www.openstreetmap.org/">OpenStreetMap</a> contributors',
					numZoomLevels: 20,
					transitionEffect: 'resize'
				}
			)
			map.addLayer(tiles);

			var markers = new OpenLayers.Layer.Vector("Markers", {
				projection: 'EPSG:4326',
				strategies: [new OpenLayers.Strategy.Fixed()],
					protocol: new OpenLayers.Protocol.HTTP({
					url: "interesting.json",
					format: new OpenLayers.Format.GeoJSON()
				})
			});
			map.addLayer(markers);
		
			var featctl = new OpenLayers.Control.SelectFeature(markers);
			map.addControl(featctl);
			featctl.activate();

			featctl.events.register('featurehighlighted', this, function(e) {
				var pt = e.feature.geometry, ll = new OpenLayers.LonLat(pt.x, pt.y);
				map.setCenter(0, 0);
			});

			map.events.register('zoomend', this, function() {
				markers.setVisibility(map.zoom < 8);
			});

			if( !map.getCenter() ){
				map.setCenter(new OpenLayers.LonLat(0, 0), 2); // despite the class name, these are in EPSG:3031, so 0/0 is actually the pole 
			}

			// begin draw box
			var zoom = 2;
			
			vectors = new OpenLayers.Layer.Vector("Vector Layer", {
				displayInLayerSwitcher: false
			});
			map.addLayer(vectors);

			box = new OpenLayers.Control.DrawFeature(vectors, OpenLayers.Handler.RegularPolygon, {
				handlerOptions: {
					sides: 4,
					snapAngle: 90,
					irregular: true,
					persist: true
				}
			});
			box.handler.callbacks.done = endDrag;
			map.addControl(box);
			
			transform = new OpenLayers.Control.TransformFeature(vectors, {
				rotate: false,
				irregular: true
			});
			
			transform.events.register("transformcomplete", transform, boxResize);
			
			map.addControl(transform);
			map.addControl(box);
			
			box.activate();
			map.setCenter(lonlat, zoom);
			// end draw box
		}
		</script>
<!--  ///////////////////////////////////////////////////// -->	

	<script>
		/*User Request Configuration*/
		var sendString = "",
			dataSet = "SSMI",
			frequency = "19",
			polarization = "h",
			startDate = "2010-12-12",
			endDate = "2010-12-20";

		loctnArray = Array();

		/*user request function*/
		var anomalyRequest = {
			"dsName": dataSet,
			"dsFreq": frequency,
			"dsPolar": polarization,
			"sDate": startDate,
			"eDate": endDate,
			"locations": loctnArray
		};

		function updateDate() {
			startDate = "" + document.getElementById('startDate').value;
			endDate = "" + document.getElementById('endDate').value;
			anomalyRequest["sDate"] = startDate;
			anomalyRequest["eDate"] = endDate;
		}

		function changeDataSet(ds) {
			dataSet = ds;
			updateDate();
			anomalyRequest["dsName"] = ds;

/*			if (ds == "AVHRR\\\") {
				document.getElementById("dataset1").style.color = "black";
				document.getElementById("dataset2").style.color = "#B6B6B4";
			} else {
				document.getElementById("dataset2").style.color = "black";
				document.getElementById("dataset1").style.color = "#B6B6B4";
			//}*/
		};

		function changeFrequency(freq) {
			frequency = freq;
			updateDate();
			//update Frequency
			anomalyRequest["dsFreq"] = freq;

			if (freq == '91') {
				document.getElementById("freq91").style.color = "black";
				document.getElementById("freq85").style.color = "#B6B6B4";
				document.getElementById("freq37").style.color = "#B6B6B4";
				document.getElementById("freq22").style.color = "#B6B6B4";
				document.getElementById("freq19").style.color = "#B6B6B4";
			} else if (freq == '85') {

				document.getElementById("freq91").style.color = "#B6B6B4";
				document.getElementById("freq85").style.color = "black";
				document.getElementById("freq37").style.color = "#B6B6B4";
				document.getElementById("freq22").style.color = "#B6B6B4";
				document.getElementById("freq19").style.color = "#B6B6B4";
			} else if (freq == '37') {
				document.getElementById("freq91").style.color = "#B6B6B4";
				document.getElementById("freq85").style.color = "#B6B6B4";
				document.getElementById("freq37").style.color = "black";
				document.getElementById("freq22").style.color = "#B6B6B4";
				document.getElementById("freq19").style.color = "#B6B6B4";
			} else if (freq == '22') {
				document.getElementById("freq91").style.color = "#B6B6B4";
				document.getElementById("freq85").style.color = "#B6B6B4";
				document.getElementById("freq37").style.color = "#B6B6B4";
				document.getElementById("freq22").style.color = "black";
				document.getElementById("freq19").style.color = "#B6B6B4";
			} else {
				document.getElementById("freq91").style.color = "#B6B6B4";
				document.getElementById("freq85").style.color = "#B6B6B4";
				document.getElementById("freq37").style.color = "#B6B6B4";
				document.getElementById("freq22").style.color = "#B6B6B4";
				document.getElementById("freq19").style.color = "black";
			}
		};

		function changePolarization(pol) {
			polarization = pol;
			updateDate();
			anomalyRequest["dsPolar"] = pol;

			if (pol == 'v') {
				document.getElementById("vertical").style.color = "black";
				document.getElementById("horizontal").style.color = "#B6B6B4";
			} else {
				document.getElementById("horizontal").style.color = "black";
				document.getElementById("vertical").style.color = "#B6B6B4";
			}
		}

		//function updatePolyArea(pa) { polyArea = pa; }
		function enablePolygonSearch() {};

		//pass full request to a new page, in localStorage
		function sendRequest(anomalyRequest) {
			updateDate();

			anomalyRequest["dsFreq"] = 's' + frequency + polarization;
			//transfer request to result page
			localStorage['userQuery'] = JSON.stringify(anomalyRequest);
			//console.log(localStorage["userQuery"]);
			var win = window.open("anomaly.html",'_blank');
			win.focus();
		};
	</script>
</head>

<body id="index" class="home" onload="setupmap()">
    <header class='container' id='header'></header>

	<nav class='container roundEdge' id='nav'>
		<center><h1 id='project'>Condensing Massive Satellite Data For Rapid Interactive Analysis</h1></center>
	</nav>
	
	<section class='container' id='main'>
		<div id='content'>
			<div id='map'>
				<div class="time"></div>
			</div>
		</div>
			
		<aside id='sidebar' class='roundEdge'>
			<br>
			<img src="images/logo.png" alt="logo" style="width:200px;height:200px;"><br><br>
			<span id="datasetName"><font color="Black">Data Set</font></span><br>
			<button id="dataset2" class="myButton" onclick="changeDataSet('SSMI')">SSMI</button><br><br>
		
			<span id="datasetFrequency"><font color="Black">Frequency [ SSMI ]</font></span><br>
			<button id="freq19" class="myButton" onclick="changeFrequency('19')">19.3</button>
			<button id="freq22" class="myButton" onclick="changeFrequency('22')">22.2</button>
			<button id="freq37" class="myButton" onclick="changeFrequency('37')">37.0</button><br>
			<button id="freq85" class="myButton" onclick="changeFrequency('85')">85.5</button>
			<button id="freq91" class="myButton" onclick="changeFrequency('91')">91.7</button><br><br>
			
			<span id="datasetPolarization"><font color="Black">Polarization [ SSMI ]</font></span><br>
			<button id="vertical" class="myButton" onclick="changePolarization('v')">vertical</button>
			<button id="horizontal" class="myButton" onclick="changePolarization('h')">horizontal</button><br><br>
		
			<span id="datasetField"><font color="Black">Start Date</font></span><br>
			<input id="startDate" name="startDate" value="2010-12-12" type="date" min="1987-01-01" max="2014-12-31" onclick="updateDate()" /><br><br>
			<span id="datasetField"><font color="Black">End Date</font></span><br>
			<input id="endDate" name="endDate" value="2010-12-20" type="date" min="1987-01-01" max="2014-12-31" onclick="updateDate()" /><br>

			<input class="myButton" value="Submit Query" onclick="sendRequest(anomalyRequest);" type="button">			

			<hr />
			<div id="bbox_drag_instruction">Click to drag a box:</div>
			<div id="bbox_adjust_instruction">Adjust the box<br> <input type="button" value="drag new box" onclick="dragNewBox();"></div>
			<div id="mapdiv"></div>
			<p id="bbox_result"> </p>

		</aside>
	</section>
	
	<footer class='container' id='footer'>
		<center><p>© 2015 NSIDC & University of Colorado at Boulder</p></center>
	</footer>
</body>
</html>

<!--
Resources:

	SSMI Page:
	<http://nsidc.org/data/docs/daac/nsidc0001_ssmi_tbs.gd.html>

	<http://dev.openlayers.org/examples/draw-feature.html>
	<http://harrywood.co.uk/maps/examples/openlayers/bbox-selector.view.html>

-->

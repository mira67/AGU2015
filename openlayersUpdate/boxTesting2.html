<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<title>Draw features example</title>
	<script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
	<link rel="stylesheet" href="http://openlayers.org/en/v3.8.2/css/ol.css" type="text/css">
	<script src="http://openlayers.org/en/v3.8.2/build/ol.js"></script>
	<script src="proj4js-2.3.3/proj4.js"></script>

	<style>
		.container-fluid {
			width: 1200px;
			height: 1200px;
		}
	</style>
	
</head>
<body>

	<div class="container-fluid">
		<div class="row-fluid">
			<div class="span12">
				<div id="map" class="map"></div>
				<form class="form-inline">
					<label>Draw &nbsp;</label>
					<select id="type">
						<option value="None">None</option>
						<option value="Box">Box</option>
					</select>
				</form>
				<p id="extent"></p>
				<!--<button onclick="buttonDrawRectangle();">draw rectangle</button>-->
				<button onclick="buttonClearRectangle();">clear rectangle</button>
			</div>
		</div>
	</div>

<script>

	proj4.defs("EPSG:3031", "+proj=stere +lat_0=-90 +lat_ts=-71 +lon_0=0 +k=1 +x_0=0 +y_0=0 +datum=WGS84 +units=m +no_defs");
	ol.proj.get("EPSG:3031").setExtent([-4194304, -4194304, 4194304, 4194304]);

	var source = new ol.source.Vector();
	var vector = new ol.layer.Vector({
		source: source,
		style: new ol.style.Style({
			fill: new ol.style.Fill({
				color: 'rgba(255, 255, 255, 0.2)'
			}),
			stroke: new ol.style.Stroke({
				color: '#ffffff',
				width: 2
			}),
			image: new ol.style.Circle({
				radius: 7,
				fill: new ol.style.Fill({
					color: '#ffffff'
				})
			})
		})
	});

	// for outputting the mouse position
	var mousePositionControl = new ol.control.MousePosition({
		coordinateFormat: ol.coordinate.createStringXY(4),
		projection: 'EPSG:3031',
		// comment the following two lines to have the mouse position
		// be placed within the map.
		//className: 'custom-mouse-position',
		//target: document.getElementById('mouse-position'),
		undefinedHTML: '&nbsp;'
	});
	
	map = new ol.Map({
		controls: ol.control.defaults().extend([mousePositionControl]), // for displaying the mouse
		view: new ol.View({
			maxResolution: 8192.0,
			projection: ol.proj.get("EPSG:3031"),
			extent: [-4194304, -4194304, 4194304, 4194304],
			center: [0, 0],
			zoom: 0.5,
			maxZoom: 5,
		}),
		target: "map",
		renderer: ["canvas","dom"],
	});

	sourceLandWater = new ol.source.WMTS({
		url: "//map1{a-c}.vis.earthdata.nasa.gov/wmts-antarctic/wmts.cgi",
		layer: "SCAR_Land_Water_Map", // jpeg 500m
		extent: [-3923000, -3923000, 3923000, 3923000],//[-4194304, -4194304, 4194304, 4194304],
		format: "image/png",
		matrixSet: "EPSG3031_250m",
		tileGrid: new ol.tilegrid.WMTS({
			origin: [-4194304, 4194304],
			resolutions: [
				8192.0,
				4096.0,
				2048.0,
				1024.0,
				512.0,
				256.0
			],
			matrixIds: [0, 1, 2, 3, 4, 5],
			tileSize: 512
		})
	});
	
	layerLandWater = new ol.layer.Tile({source: sourceLandWater});	
		sourceCoastlines = new ol.source.WMTS({
		url: "//map1{a-c}.vis.earthdata.nasa.gov/wmts-antarctic/wmts.cgi",
		layer: "Coastlines", // jpeg 500m
		extent: [-4194304, -4194304, 4194304, 4194304],
		format: "image/png",
		matrixSet: "EPSG3031_250m",
		tileGrid: new ol.tilegrid.WMTS({
			origin: [-4194304, 4194304],
			resolutions: [
				8192.0,
				4096.0,
				2048.0,
				1024.0,
				512.0,
				256.0
			],
			matrixIds: [0, 1, 2, 3, 4, 5],
			tileSize: 512
		})
	});
	layerCoastlines = new ol.layer.Tile({source: sourceCoastlines});

	// add layer for a heatmap of anomaly points
	heatmapLayer = new ol.layer.Heatmap({
		opacity: 1.0,
		source: new ol.source.Vector({
			url: 'cities.json',
			format: new ol.format.GeoJSON()
		})
	});
	
	map.addLayer(layerLandWater);
	map.addLayer(layerCoastlines);
	map.addLayer(heatmapLayer);
	map.addLayer(vector);
	
	var typeSelect = document.getElementById('type');
	var draw;
	
	function addInteraction( ){
		value = typeSelect.value;

		if( value !== 'None' ){
console.log("1");
			var geometryFunction, maxPoints;
			if( value === 'Box' ){
console.log("2");
				value = 'LineString';
				maxPoints = 2;
				geometryFunction = function( coordinates, geometry ){
					if( !geometry ){
						geometry = new ol.geom.Polygon(null);
					}
					var start = coordinates[0];
					var end = coordinates[1];
					geometry.setCoordinates([[start, [start[0], end[1]], end, [end[0], start[1]], start]]);
console.log("coordinates" + coordinates);
					return geometry;
				};
			}
			draw = new ol.interaction.Draw({
				source: source,
				type: /** @type {ol.geom.GeometryType} */ (value),
				geometryFunction: geometryFunction,
				maxPoints: maxPoints
			});
			map.addInteraction(draw);
		}
	}

	typeSelect.onchange = function(e) {
		map.removeInteraction(draw);
		addInteraction();
	};

	buttonDrawRectangle = function(){
		value = 'Box';
		map.removeInteraction(draw);
		addInteraction();
	};

	buttonClearRectangle = function(){
		source.clear();
	};	
	addInteraction();
	
</script>

</body>
</html>